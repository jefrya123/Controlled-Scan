<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PII Scanner Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            text-transform: uppercase;
            font-size: 12px;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-export {
            background: #27ae60;
        }

        .btn-export:hover {
            background: #229954;
        }

        .file-type-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .classification-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .controlled {
            background: #ffebee;
            color: #c62828;
        }

        .non-controlled {
            background: #e3f2fd;
            color: #1565c0;
        }

        .rating-stars {
            color: #f39c12;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background: white;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç PII Scanner Admin Dashboard</h1>
            <p>Real-time data and analytics</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalFiles">-</div>
                <div class="stat-label">Total Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPII">-</div>
                <div class="stat-label">PII Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="controlledPII">-</div>
                <div class="stat-label">Controlled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="nonControlledPII">-</div>
                <div class="stat-label">Non-Controlled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentUploads">-</div>
                <div class="stat-label">Last 24h</div>
            </div>
        </div>

        <div class="section">
            <h2>üìä File Type Breakdown</h2>
            <div id="fileTypeChart"></div>
        </div>

        <div class="section">
            <h2>üîç PII Type Breakdown</h2>
            <div id="piiTypeChart"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('files')">üìÅ Files</button>
            <button class="tab" onclick="showTab('results')">üîç Results</button>
            <button class="tab" onclick="showTab('feedback')">üí¨ Feedback</button>
        </div>

        <div id="filesTab" class="tab-content active">
            <div class="section">
                <h2>üìÅ Recent File Uploads</h2>
                <button class="btn btn-export" onclick="exportData('files')">Export Files Data</button>
                <table class="data-table" id="filesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Upload Time</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="filesTableBody">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="resultsTab" class="tab-content">
            <div class="section">
                <h2>üîç Scan Results</h2>
                <button class="btn btn-export" onclick="exportData('results')">Export Results Data</button>
                <table class="data-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Entity Type</th>
                            <th>Value</th>
                            <th>Classification</th>
                            <th>Confidence</th>
                            <th>Scan Time</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="feedbackTab" class="tab-content">
            <div class="section">
                <h2>üí¨ User Feedback</h2>
                <button class="btn btn-export" onclick="exportData('feedback')">Export Feedback Data</button>
                <table class="data-table" id="feedbackTable">
                    <thead>
                        <tr>
                            <th>Rating</th>
                            <th>Feedback</th>
                            <th>File Types</th>
                            <th>User Agent</th>
                            <th>IP Address</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let adminData = {};

        // Load data on page load
        window.onload = function() {
            loadStats();
            loadAdminData();
        };

        async function loadStats() {
            try {
                const response = await fetch('/stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalFiles').textContent = stats.total_files || 0;
                    document.getElementById('totalPII').textContent = stats.total_pii_found || 0;
                    document.getElementById('controlledPII').textContent = stats.controlled_pii || 0;
                    document.getElementById('nonControlledPII').textContent = stats.non_controlled_pii || 0;
                    document.getElementById('recentUploads').textContent = stats.recent_uploads_24h || 0;

                    // Update charts
                    updateFileTypeChart(stats.file_types);
                    updatePiiTypeChart(stats.pii_types);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAdminData() {
            try {
                const response = await fetch('/admin/data');
                if (response.ok) {
                    adminData = await response.json();
                    displayFiles(adminData.files);
                    displayResults(adminData.results);
                    displayFeedback(adminData.feedback);
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function displayFiles(files) {
            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = '';

            files.slice(0, 50).forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.id}</td>
                    <td>${file.filename}</td>
                    <td><span class="file-type-badge">${file.file_type}</span></td>
                    <td>${formatFileSize(file.file_size)}</td>
                    <td>${new Date(file.upload_timestamp).toLocaleString()}</td>
                    <td>${file.ip_address || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            results.slice(0, 50).forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.filename}</td>
                    <td>${result.entity_type}</td>
                    <td><code>${result.value}</code></td>
                    <td><span class="classification-badge ${result.classification}">${result.classification}</span></td>
                    <td>${Math.round(result.confidence * 100)}%</td>
                    <td>${new Date(result.scan_timestamp).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayFeedback(feedback) {
            const tbody = document.getElementById('feedbackTableBody');
            tbody.innerHTML = '';

            feedback.slice(0, 50).forEach(item => {
                const row = document.createElement('tr');
                const stars = '‚≠ê'.repeat(item.rating);
                const fileTypes = JSON.parse(item.file_types_tested || '[]').join(', ');
                
                row.innerHTML = `
                    <td><span class="rating-stars">${stars}</span></td>
                    <td>${item.feedback_text || 'N/A'}</td>
                    <td>${fileTypes || 'N/A'}</td>
                    <td><small>${item.user_agent || 'N/A'}</small></td>
                    <td>${item.ip_address || 'N/A'}</td>
                    <td>${new Date(item.feedback_timestamp).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateFileTypeChart(fileTypes) {
            const container = document.getElementById('fileTypeChart');
            container.innerHTML = '';

            Object.entries(fileTypes).forEach(([type, count]) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="file-type-badge">${type}</span>
                        <span style="font-weight: bold;">${count}</span>
                    </div>
                    <div style="background: #ecf0f1; height: 8px; border-radius: 4px; margin-top: 5px;">
                        <div style="background: #3498db; height: 100%; width: ${(count / Math.max(...Object.values(fileTypes))) * 100}%; border-radius: 4px;"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updatePiiTypeChart(piiTypes) {
            const container = document.getElementById('piiTypeChart');
            container.innerHTML = '';

            Object.entries(piiTypes).forEach(([type, count]) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold;">${type}</span>
                        <span style="font-weight: bold;">${count}</span>
                    </div>
                    <div style="background: #ecf0f1; height: 8px; border-radius: 4px; margin-top: 5px;">
                        <div style="background: #e74c3c; height: 100%; width: ${(count / Math.max(...Object.values(piiTypes))) * 100}%; border-radius: 4px;"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function exportData(type) {
            let data = [];
            let filename = '';

            switch(type) {
                case 'files':
                    data = adminData.files;
                    filename = 'pii_scanner_files.json';
                    break;
                case 'results':
                    data = adminData.results;
                    filename = 'pii_scanner_results.json';
                    break;
                case 'feedback':
                    data = adminData.feedback;
                    filename = 'pii_scanner_feedback.json';
                    break;
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadAdminData();
        }, 30000);
    </script>
</body>
</html> 